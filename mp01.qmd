---
title: "Mini Project 1:Exploring the Most Popular Programming on Netflix"
author: Wendy Fung-Wu
format: 
 html:
   theme: minty
   toc: true
   toc-depth: 3
   code-fold: true
   code-summary: "Show code"
   embed-resources: true
editor: visual
execute: 
   warning: false
   message: false
   echo: true
---
## Executive Summary
This analysis looks at Netflix viewing trends around the world, covering 94 countries with a date range from 2021-07-04 to 2025-08-24. This report examines what people are watching, which shows and movies are the most popular, and how preferences can vary by region. The data set includes 2791 unique titles.


```{r}
# Acquire Data
if(!dir.exists(file.path("data", "mp01"))){
  dir.create(file.path("data", "mp01"), showWarnings=FALSE, recursive=TRUE)
}

GLOBAL_TOP_10_FILENAME <- file.path("data", "mp01", "global_top10_alltime.csv")

if(!file.exists(GLOBAL_TOP_10_FILENAME)){
  download.file("https://www.netflix.com/tudum/top10/data/all-weeks-global.tsv", 
                destfile=GLOBAL_TOP_10_FILENAME)
}

COUNTRY_TOP_10_FILENAME <- file.path("data", "mp01", "country_top10_alltime.csv")

if(!file.exists(COUNTRY_TOP_10_FILENAME)){
  download.file("https://www.netflix.com/tudum/top10/data/all-weeks-countries.tsv", 
                destfile=COUNTRY_TOP_10_FILENAME)
}
```

```{r}
# Data Import and Preparation
if(!require("tidyverse")) install.packages("tidyverse")
library(readr)
library(dplyr)

GLOBAL_TOP_10 <- read_tsv(GLOBAL_TOP_10_FILENAME)

str(GLOBAL_TOP_10)

glimpse(GLOBAL_TOP_10)
```

```{r}
# Data Cleaning 
GLOBAL_TOP_10 <- GLOBAL_TOP_10 |>
  mutate(season_title = if_else(season_title %in% c("N/A", ""), 
                                NA_character_, 
                                season_title))

COUNTRY_TOP_10 <- read_tsv(COUNTRY_TOP_10_FILENAME, na = "N/A", show_col_types = FALSE) |>
  mutate(season_title = if_else(season_title == "", NA_character_, season_title))

format_titles <- function(df){
  colnames(df) <- str_replace_all(colnames(df), "_", " ") |> str_to_title()
  df
}

total_countries <- COUNTRY_TOP_10 |> distinct(country_iso2) |> nrow()
date_range <- paste(min(GLOBAL_TOP_10$week), "to", max(GLOBAL_TOP_10$week))
total_shows <- GLOBAL_TOP_10 |> distinct(show_title) |> nrow()

library(DT)
GLOBAL_TOP_10 |> 
  head(n=20) |>
  datatable(options=list(searching=FALSE, info=FALSE))
```

```{r}
# Initial Data Exploration
library(DT)
GLOBAL_TOP_10 |> 
  head(n=20) |>
  datatable(options=list(searching=FALSE, info=FALSE))

library(stringr)
format_titles <- function(df){
  colnames(df) <- str_replace_all(colnames(df), "_", " ") |> str_to_title()
  df
}

GLOBAL_TOP_10 |> 
  format_titles() |>
  head(n=20) |>
  datatable(options=list(searching=FALSE, info=FALSE)) |>
  formatRound(c('Weekly Hours Viewed', 'Weekly Views'))
```

```{r}
# Drop season_tile
GLOBAL_TOP_10 |> 
  select(-season_title) |>
  format_titles() |>
  head(n=20) |>
  datatable(options=list(searching=FALSE, info=FALSE)) |>
  formatRound(c('Weekly Hours Viewed', 'Weekly Views'))
```

```{r}
# Convert to minutes
GLOBAL_TOP_10 |> 
  mutate(`runtime_(minutes)` = round(60 * runtime)) |>
  select(-season_title, 
         -runtime) |>
  format_titles() |>
  head(n=20) |>
  datatable(options=list(searching=FALSE, info=FALSE)) |>
  formatRound(c('Weekly Hours Viewed', 'Weekly Views'))
```

## Exploratory Questions
1. How many different countries does Netflix operate in? 
```{r}
country_count <- COUNTRY_TOP_10 |> 
  distinct(country_iso2) |> 
  nrow()
```
Netflix operates in **`r country_count`** countries

2. Which non-English-language film has spent the most cumulative weeks in the global top 10? How many weeks did it spend?
```{r}
non_english_film <- GLOBAL_TOP_10 |>
  filter(category == "Films (Non-English)") |>
  group_by(show_title) |>
  summarise(total_weeks = max(cumulative_weeks_in_top_10, na.rm = TRUE)) |>
  arrange(desc(total_weeks)) |>
  slice(1)

non_english_film_title <- non_english_film$show_title[1]
non_english_film_weeks <- non_english_film$total_weeks[1]
```
The non-English film with the most weeks in the global Top 10 is **`r non_english_film_title`**, with **`r non_english_film_weeks`** weeks.

3. What is the longest film (English or non-English) to have ever appeared in the Netflix global Top 10? How long is it in minutes? [Note that Netflix does not provide runtime for programs before a certain date, so your answer here may be a bit limited.]
```{r}
longest_film <- GLOBAL_TOP_10 |>
  filter(str_detect(category, "Films")) |>
  filter(!is.na(runtime)) |>
  mutate(runtime_minutes = round(60 * runtime)) |>
  arrange(desc(runtime_minutes)) |>
  slice(1)

longest_film_title <- longest_film$show_title[1]
longest_film_minutes <- longest_film$runtime_minutes[1]
```
The longest film to appear in the Netflix global Top 10 is **`r longest_film_title`**, with a runtime of **`r longest_film_minutes`** minutes.

4. For each of the four categories, what program has the most total hours of global viewership?
```{r}
top_programs_by_category <- GLOBAL_TOP_10 |>
  group_by(category, show_title) |>
  summarise(total_hours = sum(weekly_hours_viewed, na.rm = TRUE), .groups = "drop") |>
  group_by(category) |>
  slice_max(total_hours, n = 1) |>
  arrange(desc(total_hours))
top_programs_by_category |>
  mutate(total_hours = scales::comma(total_hours)) |>
  select(category, show_title, total_hours) |>
  format_titles() |>
  datatable(
    options = list(searching = FALSE, info = FALSE),
    caption = "Top Programs by Category"
  )
```

5. Which TV show had the longest run in a country’s Top 10? How long was this run and in what country did it occur?
```{r}
longest_country_run <- COUNTRY_TOP_10 |>
  filter(str_detect(category, "TV")) |>
  group_by(country_name, show_title) |>
  summarise(max_weeks = max(cumulative_weeks_in_top_10, na.rm = TRUE), .groups = "drop") |>
  arrange(desc(max_weeks)) |>
  slice(1)

longest_country_run_title <- longest_country_run$show_title[1]
longest_country_run_country <- longest_country_run$country_name[1]
longest_country_run_weeks <- longest_country_run$max_weeks[1]
```
The TV show with the longest run in a country’s Top 10 is **`r longest_country_run_title`**, lasting **`r longest_country_run_weeks`** weeks in **`r longest_country_run_country`**.

6. Netflix provides over 200 weeks of service history for all but one country in our data set. Which country is this and when did Netflix cease operations in that country?
```{r}
library(lubridate)
country_weeks <- COUNTRY_TOP_10 |>
  group_by(country_name) |>
  summarise(
    weeks_count = n_distinct(week),
    last_week = max(week, na.rm = TRUE),
    .groups = "drop"
  ) |>
  filter(weeks_count < 200) |>
  arrange(weeks_count)

short_country_name <- country_weeks$country_name[1]
short_country_weeks <- country_weeks$weeks_count[1]
short_country_last_week <- country_weeks$last_week[1]
```
The country with fewer than 200 weeks of service history is **`r short_country_name`**, with **`r short_country_weeks`** weeks of data. Netflix ceased operations there in **`r short_country_last_week`**.

7.What is the total viewership of the TV show Squid Game? Note that there are three seasons total and we are looking for the total number of hours watched across all seasons.
```{r}
squid_game_total <- GLOBAL_TOP_10 |>
  filter(str_detect(show_title, "Squid Game")) |>
  summarise(total_hours = sum(weekly_hours_viewed, na.rm = TRUE)) |>
  pull(total_hours)
squid_game_total_fmt <- scales::comma(squid_game_total)
```
The total viewership of Squid Game across all seasons is **`r squid_game_total_fmt`** hours.

8.The movie Red Notice has a runtime of 1 hour and 58 minutes. Approximately how many views did it receive in 2021? [Hint: The year() function from the lubridate package may be helpful.]
```{r}
library(lubridate)

red_notice_2021 <- GLOBAL_TOP_10 |>
  filter(show_title == "Red Notice", year(week) == 2021) |>
  summarise(total_views = sum(weekly_views, na.rm = TRUE)) |>
  pull(total_views)
```
The movie Red Notice received approximately **`r scales::comma(red_notice_2021)`** views in 2021.

9. How many Films reached Number 1 in the US but did not originally debut there? That is, find films that first appeared on the Top 10 chart at, e.g., Number 4 but then became more popular and eventually hit Number 1? What is the most recent film to pull this off? [Hint: You will want to create a new variable to identify films that topped the charts at any point during their run.]
```{r}
# Filter US films and calculate debut and whether they ever hit #1
us_films <- COUNTRY_TOP_10 |>
  filter(country_name == "United States", str_detect(category, "Films")) |>
  group_by(show_title) |>
  arrange(week) |>
  mutate(
    ever_hit_1 = any(weekly_rank == 1),
    debut_rank = first(weekly_rank),
    latest_week = max(week)
  ) |>
  filter(ever_hit_1 == TRUE, debut_rank > 1) |>
  ungroup()

# Total number of films
us_films_count <- nrow(distinct(us_films, show_title))

# Most recent film to achieve this
most_recent_us_film <- us_films |>
  arrange(desc(latest_week)) |>
  slice(1) |>
  pull(show_title)
```
 **`r us_films_count`** films are eventually reached Number 1 in the US despite not debuting there.

The most recent film to achieve this feat is **`r most_recent_us_film`**.

10.Which TV show/season hit the top 10 in the most countries in its debut week? In how many countries did it chart?
```{r}
tv_debut_countries <- COUNTRY_TOP_10 |>
  filter(str_detect(category, "TV")) |>
  group_by(show_title) |>
  filter(week == min(week)) |>
  summarise(countries_count = n_distinct(country_name), .groups = "drop") |>
  arrange(desc(countries_count)) |>
  slice(1)

top_tv_debut_title <- tv_debut_countries$show_title[1]
top_tv_debut_countries <- tv_debut_countries$countries_count[1]
```

The TV show/season that hit the Top 10 in the most countries during its debut week is **`r top_tv_debut_title`**, charting in **`r top_tv_debut_countries`** countries.